{% extends "base.html" %}

{% block title %}Backup Management - The Grey Canvas{% endblock %}

{% block meta_description %}Automated backup management dashboard for The Grey Canvas business data and configurations.{% endblock %}

{% block content %}
<div class="min-h-screen bg-black bg-opacity-75 backdrop-blur-md p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg p-6 mb-6 border border-white border-opacity-20">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-playfair font-bold text-white mb-2">Backup Management</h1>
                    <p class="text-gray-300">Automated daily backups of your business data</p>
                </div>
                <div class="flex space-x-4">
                    <form method="POST" action="{{ url_for('create_backup') }}" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" 
                                class="bg-[#E0218A] hover:bg-[#C1185E] text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                            Create Backup Now
                        </button>
                    </form>
                    <a href="{{ url_for('admin_console') }}" 
                       class="bg-[#7A7A7A] hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                        Back to Admin
                    </a>
                </div>
            </div>
        </div>

        <!-- Backup Status Cards -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg p-6 border border-white border-opacity-20">
                <div class="flex items-center">
                    <div class="p-3 bg-green-500 bg-opacity-20 rounded-lg">
                        <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-300 text-sm">Total Backups</p>
                        <p class="text-2xl font-bold text-white">{{ backup_files|length }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg p-6 border border-white border-opacity-20">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-500 bg-opacity-20 rounded-lg">
                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-300 text-sm">Latest Backup</p>
                        <p class="text-lg font-bold text-white">
                            {% if backup_files %}
                                {{ backup_files[0].created.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                Never
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg p-6 border border-white border-opacity-20">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-500 bg-opacity-20 rounded-lg">
                        <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-300 text-sm">Total Size</p>
                        <p class="text-lg font-bold text-white">
                            {% set total_size = backup_files | sum(attribute='size') %}
                            {{ "%.1f"|format(total_size) }} MB
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup Schedule Info -->
        <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg p-6 mb-8 border border-white border-opacity-20">
            <h2 class="text-xl font-playfair font-bold text-white mb-4">Automated Backup Schedule</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">Daily Backups</h3>
                    <p class="text-gray-300 mb-2">Automatic backups run every day at 2:00 AM</p>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>• Complete database export (JSON + SQL)</li>
                        <li>• All project files and templates</li>
                        <li>• Configuration files</li>
                        <li>• Compressed into downloadable archive</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">Retention Policy</h3>
                    <p class="text-gray-300 mb-2">Automatic cleanup every Sunday at 3:00 AM</p>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>• Keeps backups for 30 days</li>
                        <li>• Removes older backup files automatically</li>
                        <li>• Manual backups follow same retention</li>
                        <li>• Download backups before deletion</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Backup Files List -->
        <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg border border-white border-opacity-20">
            <div class="p-6 border-b border-white border-opacity-20">
                <h2 class="text-xl font-playfair font-bold text-white">Available Backups</h2>
                <p class="text-gray-300 text-sm mt-1">Download or manage your backup files</p>
            </div>

            {% if backup_files %}
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-black bg-opacity-20">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">File Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Size</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white divide-opacity-10">
                            {% for backup in backup_files %}
                            <tr class="hover:bg-white hover:bg-opacity-5 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span class="text-white font-medium">{{ backup.name }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                                    {{ backup.size }} MB
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                                    {{ backup.created.strftime('%Y-%m-%d %H:%M:%S') }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('download_backup', filename=backup.name) }}" 
                                           class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                            Download
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_backup', filename=backup.name) }}" 
                                              class="inline" 
                                              onsubmit="return confirm('Are you sure you want to delete this backup?')">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" 
                                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                                Delete
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="p-8 text-center">
                    <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-white mb-2">No Backups Available</h3>
                    <p class="text-gray-300 mb-4">Create your first backup to get started with data protection.</p>
                    <form method="POST" action="{{ url_for('create_backup') }}" class="inline">
                        {{ csrf_token() }}
                        <button type="submit" 
                                class="bg-[#E0218A] hover:bg-[#C1185E] text-white px-6 py-2 rounded-lg font-semibold transition-all duration-300">
                            Create First Backup
                        </button>
                    </form>
                </div>
            {% endif %}
        </div>

        <!-- Instructions -->
        <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg p-6 mt-8 border border-white border-opacity-20">
            <h2 class="text-xl font-playfair font-bold text-white mb-4">How to Use Backups</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">Creating Backups</h3>
                    <ul class="text-gray-300 text-sm space-y-2">
                        <li>• Click "Create Backup Now" for immediate backup</li>
                        <li>• Automatic daily backups run at 2:00 AM</li>
                        <li>• Each backup includes all business data</li>
                        <li>• Backups are compressed for easy download</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">Managing Backups</h3>
                    <ul class="text-gray-300 text-sm space-y-2">
                        <li>• Download backups to store offline</li>
                        <li>• Delete old backups to save space</li>
                        <li>• Backups older than 30 days auto-delete</li>
                        <li>• Contact support for restore assistance</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh backup status every 30 seconds
setInterval(function() {
    fetch('{{ url_for("backup_status") }}')
        .then(response => response.json())
        .then(data => {
            // Update status if needed
            console.log('Backup status updated:', data);
        })
        .catch(error => console.log('Status update failed:', error));
}, 30000);
</script>
{% endblock %}